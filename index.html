<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Affiliate AI Studio Ultimate</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom CSS -->
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #18181b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #52525b; }
        .animate-in { animation-duration: 0.5s; animation-fill-mode: both; }
        .fade-in { animation-name: fadeIn; }
        .slide-in-from-bottom-4 { animation-name: slideInBottom; }
        .slide-in-from-right-4 { animation-name: slideInRight; }
        .slide-in-from-left-4 { animation-name: slideInLeft; }
        .zoom-in { animation-name: zoomIn; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInBottom { from { transform: translateY(1rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(1rem); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-1rem); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Loading Overlay */
        #app-loading { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; color: #00f2ea; font-family: sans-serif; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: #00f2ea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-black text-white overflow-hidden">
    
    <!-- LOADING SCREEN -->
    <div id="app-loading">
        <div class="text-center">
            <div class="spinner mb-4 mx-auto"></div>
            <p>Memuat Studio...</p>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, Component } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Sparkles, Video, Download, Play, Pause, Loader2, Upload, X, ImagePlus, 
            Zap, ScanEye, Copy, Type, ShoppingBag, TrendingUp, Mic, BarChart3, 
            User, Palette as PaletteIcon, Box, Smile, Plus, Trash2, Eye, Wand2, 
            CheckCircle2, ClipboardPaste, Key, MinusCircle 
        } from 'lucide-react';

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("React Error:", error, errorInfo);
                this.setState({ errorInfo });
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center h-screen bg-zinc-900 text-red-400 p-8 text-center">
                            <h2 className="text-2xl font-bold mb-4">Terjadi Kesalahan Aplikasi</h2>
                            <p className="mb-4 text-white">Jangan khawatir, ini detail errornya:</p>
                            <div className="bg-black p-4 rounded text-left font-mono text-xs overflow-auto max-w-2xl border border-red-900">
                                {this.state.error && this.state.error.toString()}
                                <br/>
                                {this.state.errorInfo && this.state.errorInfo.componentStack}
                            </div>
                            <button onClick={() => window.location.reload()} className="mt-6 px-6 py-3 bg-red-600 text-white rounded-full hover:bg-red-700">Refresh Halaman</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- HELPER AUDIO ---
        const base64ToBlob = (base64) => {
            try {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
                return bytes.buffer;
            } catch (e) { console.error("Audio Decode Error", e); return null; }
        };

        const pcmToWavUrl = (pcmData, sampleRate = 24000) => {
            if (!pcmData) return null;
            const header = new ArrayBuffer(44);
            const view = new DataView(header);
            const totalDataLen = pcmData.byteLength;
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + totalDataLen, true); writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); 
            view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(view, 36, 'data');
            view.setUint32(40, totalDataLen, true);
            return URL.createObjectURL(new Blob([header, pcmData], { type: 'audio/wav' }));
        };

        function TikTokAffiliateStudio() {
            // STATE
            const [apiKey, setApiKey] = useState("AIzaSyDBnGH5LaL19SM0vAYol6brYr_LOVrqZ6w"); // API KEY BARU
            const [showApiModal, setShowApiModal] = useState(false);

            const audioRef = useRef(null);
            const [prompt, setPrompt] = useState('');
            const [productImage, setProductImage] = useState(null); 
            const [refImage, setRefImage] = useState(null);       
            const [isDraggingProduct, setIsDraggingProduct] = useState(false);
            const [isDraggingRef, setIsDraggingRef] = useState(false);

            const [referenceType, setReferenceType] = useState('Product'); 
            const [aspectRatio, setAspectRatio] = useState('9:16');
            const [artStyle, setArtStyle] = useState('Aesthetic Studio');
            const [scriptTone, setScriptTone] = useState('Racun TikTok (Hype)'); 
            
            const [generatedImage, setGeneratedImage] = useState(null); 
            const [generatedBatch, setGeneratedBatch] = useState([]); 
            const [isGeneratingImg, setIsGeneratingImg] = useState(false);
            const [isGeneratingVideo, setIsGeneratingVideo] = useState(false);
            const [isUpscaling, setIsUpscaling] = useState(false);
            const [isGeneratingScript, setIsGeneratingScript] = useState(false);
            const [isGeneratingVoice, setIsGeneratingVoice] = useState(false); 
            const [isAnalyzingProduct, setIsAnalyzingProduct] = useState(false); 
            const [generatedScript, setGeneratedScript] = useState(null);
            const [voiceUrl, setVoiceUrl] = useState(null); 
            const [showScriptPanel, setShowScriptPanel] = useState(false);
            const [showCompare, setShowCompare] = useState(false); 
            const [videoMode, setVideoMode] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [isAudioPlaying, setIsAudioPlaying] = useState(false);
            const [error, setError] = useState(null);

            // Hide loading screen on mount
            useEffect(() => {
                const loader = document.getElementById('app-loading');
                if(loader) loader.style.opacity = '0';
                setTimeout(() => { if(loader) loader.style.display = 'none'; }, 500);
            }, []);

            // Check API Key (Use hardcoded key if available)
            useEffect(() => {
                if (!apiKey) {
                    const storedKey = localStorage.getItem("gemini_api_key");
                    if (storedKey) {
                        setApiKey(storedKey);
                        setShowApiModal(false);
                    } else {
                        setShowApiModal(true);
                    }
                }
            }, []);

            const saveApiKey = (key) => {
                if(key.trim().length > 10) {
                    setApiKey(key.trim());
                    localStorage.setItem("gemini_api_key", key.trim());
                    setShowApiModal(false);
                } else {
                    alert("API Key tidak valid!");
                }
            };

            const styles = [
                { id: 'Aesthetic Studio', label: 'Studio Minimalis', desc: 'Bersih, terang, background polos estetik', color: 'from-pink-500 to-rose-400' },
                { id: 'Cozy Home', label: 'Cozy Home', desc: 'Suasana rumah hangat, kayu, soft lighting', color: 'from-orange-400 to-amber-500' },
                { id: 'Luxury Showcase', label: 'Mewah & Elegan', desc: 'Gelap, emas, spotlight, premium feel', color: 'from-slate-700 to-slate-900' },
                { id: 'Outdoor Lifestyle', label: 'Outdoor Alam', desc: 'Cahaya matahari, alam, fresh', color: 'from-green-500 to-emerald-600' },
                { id: 'Neon Pop', label: 'Neon Viral', desc: 'Warna-warni kontras tinggi, Gen-Z style', color: 'from-purple-500 to-indigo-600' },
                { id: 'Soft Pastel', label: 'Cewek Kue', desc: 'Warna pastel lembut, cute, dreamy', color: 'from-blue-300 to-pink-300' },
            ];

            const aspectRatios = [
                { id: '9:16', label: '9:16 (TikTok)', icon: <div className="w-3 h-5 border-2 border-current rounded-sm bg-current"/> },
                { id: '3:4', label: '3:4 (Portrait)', icon: <div className="w-3 h-4 border-2 border-current rounded-sm"/> },
                { id: '1:1', label: '1:1 (Square)', icon: <div className="w-4 h-4 border-2 border-current rounded-sm"/> },
                { id: '4:3', label: '4:3 (Photo)', icon: <div className="w-4 h-3 border-2 border-current rounded-sm"/> },
                { id: '16:9', label: '16:9 (Wide)', icon: <div className="w-5 h-3 border-2 border-current rounded-sm"/> },
            ];

            const tones = ['Racun TikTok (Hype)', 'Storytelling (Emosional)', 'Edukasi (Professional)', 'Review Jujur (Santai)', 'FOMO (Mendesak)'];
            const refTypes = [{ id: 'Product', label: 'Hanya Produk' }, { id: 'Model', label: '+ Model/Pose' }, { id: 'Face', label: '+ Wajah' }, { id: 'Style', label: '+ Gaya' }];

            const renderRefIcon = (type) => {
                switch(type) {
                    case 'Product': return <Box size={14}/>; case 'Model': return <User size={14}/>;
                    case 'Face': return <Smile size={14}/>; case 'Style': return <PaletteIcon size={14}/>;
                    default: return <Box size={14}/>;
                }
            };

            const analyzeProduct = async (base64Image) => {
                setIsAnalyzingProduct(true);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Analyze this product image briefly for sales prompt." }, { inlineData: { mimeType: "image/png", data: base64Image.split(',')[1] } }] }] })
                    });
                    const d = await res.json();
                    if(d.candidates?.[0]?.content?.parts?.[0]?.text) setPrompt(d.candidates[0].content.parts[0].text.trim());
                } catch (e) {} finally { setIsAnalyzingProduct(false); }
            };

            const processFile = (file, setFunction) => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setFunction(reader.result);
                        setGeneratedImage(null);
                        if (setFunction === setProductImage) {
                            const img = new Image(); img.src = reader.result;
                            img.onload = () => {
                                const r = img.width / img.height;
                                if (r > 1.6) setAspectRatio('16:9'); else if (r > 1.2) setAspectRatio('4:3');
                                else if (r >= 0.9) setAspectRatio('1:1'); else if (r > 0.6) setAspectRatio('3:4'); else setAspectRatio('9:16');
                            };
                            if (apiKey) analyzeProduct(reader.result);
                        }
                    };
                    reader.readAsDataURL(file);
                } else setError("File harus gambar (JPG/PNG)");
            };

            const handleProductUpload = (e) => processFile(e.target.files[0], setProductImage);
            const handleRefUpload = (e) => processFile(e.target.files[0], setRefImage);
            const handleDragOver = (e, setDrag) => { e.preventDefault(); setDrag(true); };
            const handleDragLeave = (e, setDrag) => { e.preventDefault(); setDrag(false); };
            const handleDrop = (e, setDrag, setFn) => { e.preventDefault(); setDrag(false); if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0], setFn); };

            useEffect(() => {
                const handlePaste = (e) => {
                    const items = e.clipboardData.items;
                    for (const item of items) {
                        if (item.type.indexOf('image') !== -1) {
                            const blob = item.getAsFile();
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const base64 = event.target.result;
                                if (!productImage) { setProductImage(base64); if(apiKey) analyzeProduct(base64); } 
                                else if (referenceType !== 'Product' && !refImage) { setRefImage(base64); } 
                                else { setProductImage(base64); if(apiKey) analyzeProduct(base64); }
                            };
                            reader.readAsDataURL(blob);
                        }
                    }
                };
                window.addEventListener('paste', handlePaste);
                return () => window.removeEventListener('paste', handlePaste);
            }, [productImage, refImage, referenceType, apiKey]);

            const handleAudioPlay = () => {
                if (audioRef.current) { if (isAudioPlaying) audioRef.current.pause(); else audioRef.current.play(); setIsAudioPlaying(!isAudioPlaying); }
            };

            const handleGenerateScript = async () => {
                if (!apiKey) { setShowApiModal(true); return; }
                if (!prompt && !productImage) return setError("Upload produk dulu!");
                setIsGeneratingScript(true); setShowScriptPanel(true); setError(null); setVoiceUrl(null);
                try {
                    let body = { contents: [{ parts: [{ text: `Peran: Expert TikTok. Script viral untuk "${prompt}". Tone: ${scriptTone}. JSON: { "viral_score": 90, "reason": "...", "hook": "...", "script_body": "text paragraph", "cta": "...", "hashtags": "..." }` }] }], generationConfig: { responseMimeType: "application/json" } };
                    if (productImage) body.contents[0].parts.push({ inlineData: { mimeType: "image/png", data: productImage.split(',')[1] } });
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error.message);
                    let script = JSON.parse(data.candidates[0].content.parts[0].text);
                    if (typeof script.script_body !== 'string') script.script_body = JSON.stringify(script.script_body);
                    setGeneratedScript(script);
                } catch (err) { 
                    console.error(err);
                    setError("Gagal membuat script: " + err.message);
                } finally { setIsGeneratingScript(false); }
            };

            const handleGenerateVoiceover = async () => {
                if (!generatedScript || !apiKey) return; setIsGeneratingVoice(true);
                try {
                    const text = `${generatedScript.hook}. ${generatedScript.script_body}. ${generatedScript.cta}`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } } }) });
                    const d = await res.json();
                    if (d.error) throw new Error(d.error.message);
                    if(d.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data) setVoiceUrl(pcmToWavUrl(base64ToBlob(d.candidates[0].content.parts[0].inlineData.data)));
                } catch (err) { setError("Gagal TTS: " + err.message); } finally { setIsGeneratingVoice(false); }
            };

            const handleGenerateImage = async () => {
                if (!apiKey) { setShowApiModal(true); return; }
                if (!prompt && !productImage) return setError("Upload produk!");
                setIsGeneratingImg(true); setError(null); setVideoMode(false); setGeneratedImage(null); setGeneratedBatch([]);
                try {
                    let newImages = [];
                    const affiliatePrompt = `Product photography of ${prompt}. Style: ${artStyle}. Aspect Ratio: ${aspectRatio}. 4k.`;
                    
                    if (productImage || refImage) {
                        let contents = []; let inst = "";
                        if (productImage) { contents.push({ inlineData: { mimeType: "image/png", data: productImage.split(',')[1] } }); inst += "Img 1 is PRODUCT. Preserve details. "; }
                        if (refImage && referenceType !== 'Product') {
                            contents.push({ inlineData: { mimeType: "image/png", data: refImage.split(',')[1] } });
                            if (referenceType === 'Model') inst += "Img 2 is POSE ref. "; else if (referenceType === 'Face') inst += "Img 2 is FACE ref. "; else inst += "Img 2 is STYLE ref. ";
                        } else if (referenceType === 'Product') inst += `Place in ${artStyle} bg. `;
                        
                        const vars = [`Professional shot. ${inst}`, `Close-up. ${inst}`, `Lifestyle. ${inst}`, `Creative. ${inst}`];
                        const fetchOne = async (ins) => {
                            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [...contents.map(c=>({role:"user",parts:[c]})), {role:"user",parts:[{text:`${ins} ${affiliatePrompt}`}]}], generationConfig: { responseModalities: ["TEXT", "IMAGE"] } }) });
                            const d = await r.json();
                            if(d.error) return null;
                            const b64 = d.candidates?.[0]?.content?.parts?.find(p=>p.inlineData)?.inlineData?.data;
                            return b64 ? `data:image/png;base64,${b64}` : null;
                        };
                        const res = await Promise.all(vars.map(v => fetchOne(v)));
                        newImages = res.filter(i => i !== null);
                    } else {
                        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ instances: [{ prompt: affiliatePrompt }], parameters: { sampleCount: 4, aspectRatio } }) });
                        const d = await r.json();
                        if (d.predictions) newImages = d.predictions.map(p => `data:image/png;base64,${p.bytesBase64Encoded}`);
                    }
                    if (newImages.length > 0) { setGeneratedBatch(newImages); setGeneratedImage(newImages[0]); if (!generatedScript) handleGenerateScript(); } 
                    else throw new Error("Gagal generate. Periksa API Key.");
                } catch (err) { setError(err.message || "Gagal generate gambar."); } finally { setIsGeneratingImg(false); }
            };

            const handleUpscale = async () => {
                if (!generatedImage || !apiKey) return; setIsUpscaling(true);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: "Upscale to 4K." }, { inlineData: { mimeType: "image/png", data: generatedImage.split(',')[1] } }] }], generationConfig: { responseModalities: ["TEXT", "IMAGE"] } }) });
                    const d = await res.json();
                    const b64 = d.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    if(b64) { const n = `data:image/png;base64,${b64}`; setGeneratedImage(n); setGeneratedBatch([n]); }
                } catch(e) { setError("Upscale gagal."); } finally { setIsUpscaling(false); }
            };

            const handleGenerateVideo = () => {
                if (!generatedImage) return; setIsGeneratingVideo(true);
                setTimeout(() => {
                    setIsGeneratingVideo(false); setVideoMode(true); setIsPlaying(true);
                    if (voiceUrl && audioRef.current) { audioRef.current.play(); setIsAudioPlaying(true); }
                }, 2000);
            };

            const handleDownload = () => {
                const link = document.createElement('a'); link.href = generatedImage; link.download = `tiktok_${Date.now()}.png`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            // RENDER UI
            return (
                <div className="h-screen bg-black text-white font-sans flex flex-col relative overflow-hidden selection:bg-cyan-500/30">
                    <audio ref={audioRef} src={voiceUrl} onEnded={() => setIsAudioPlaying(false)} />
                    
                    {/* API KEY MODAL */}
                    {showApiModal && (
                        <div className="absolute inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
                            <div className="bg-zinc-900 border border-zinc-700 p-6 rounded-2xl max-w-md w-full shadow-2xl animate-in zoom-in">
                                <div className="flex items-center gap-2 mb-4 text-[#00f2ea]">
                                    <Key className="w-6 h-6"/>
                                    <h2 className="text-xl font-bold">Masukkan API Key</h2>
                                </div>
                                <p className="text-sm text-zinc-400 mb-4">Untuk menggunakan fitur AI (Gratis), Anda perlu Google Gemini API Key.</p>
                                <input id="apiInput" type="text" placeholder="Paste API Key (AIza...)" className="w-full bg-black border border-zinc-700 rounded-lg px-4 py-3 text-white mb-4 focus:border-[#00f2ea] outline-none"/>
                                <div className="flex gap-2">
                                    <button onClick={() => saveApiKey(document.getElementById('apiInput').value)} className="flex-1 bg-[#00f2ea] text-black font-bold py-3 rounded-lg hover:bg-[#00c2ff] transition-colors">Simpan & Lanjutkan</button>
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="flex-1 border border-zinc-700 text-center py-3 rounded-lg hover:bg-zinc-800 text-zinc-300">Dapat Key Gratis</a>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* BACKGROUND */}
                    <div className="absolute inset-0 z-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-[-10%] right-[-10%] w-[50%] h-[50%] bg-[#00f2ea]/10 rounded-full blur-[120px] animate-pulse"></div>
                        <div className="absolute bottom-[-10%] left-[-10%] w-[50%] h-[50%] bg-[#ff0050]/10 rounded-full blur-[120px] delay-1000"></div>
                    </div>

                    {/* TOPBAR */}
                    <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-30 bg-black/20 backdrop-blur-md border-b border-white/5">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-gradient-to-br from-[#00f2ea] to-[#ff0050] rounded-lg flex items-center justify-center text-black shadow-[0_0_15px_rgba(0,242,234,0.5)]"><ShoppingBag size={20}/></div>
                            <h1 className="font-bold text-lg tracking-tight flex items-center gap-1">Affiliate AI <span className="text-[10px] bg-white text-black px-1.5 py-0.5 rounded font-bold">ULTIMATE</span></h1>
                        </div>
                        <div className="flex bg-zinc-900/80 p-1 rounded-lg border border-zinc-800 gap-1 overflow-x-auto max-w-[50vw] custom-scrollbar">
                            {aspectRatios.map(r => (
                                <button key={r.id} onClick={() => setAspectRatio(r.id)} className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-all ${aspectRatio === r.id ? 'bg-zinc-700 text-white' : 'text-zinc-500 hover:text-zinc-300'}`}>{r.icon} {r.id}</button>
                            ))}
                        </div>
                    </div>

                    <div className="flex-1 flex overflow-hidden pt-16">
                        {/* LEFT PREVIEW */}
                        <div className="flex-1 relative flex items-center justify-center bg-black/50 overflow-hidden">
                            {(!generatedImage && !isGeneratingImg && !isUpscaling && !productImage) && (
                                <div className="text-center space-y-4 max-w-md animate-in zoom-in duration-500">
                                    <div className="w-32 h-48 mx-auto border-2 border-dashed border-zinc-700 rounded-xl flex flex-col items-center justify-center bg-zinc-900/50">
                                        <ClipboardPaste className="w-8 h-8 text-zinc-600 mb-2"/><span className="text-xs text-zinc-500 px-4">Paste (Ctrl+V) / Drop</span>
                                    </div>
                                    <div><h2 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-[#00f2ea] to-[#ff0050]">Dominasi FYP.</h2><p className="text-zinc-400 text-sm mt-2">Upload produk, AI akan otomatis membuat konten.</p></div>
                                </div>
                            )}
                            
                            {(isGeneratingImg || isUpscaling) && <div className="flex flex-col items-center"><Loader2 className="w-10 h-10 text-[#00f2ea] animate-spin mb-4"/><p className="text-zinc-300 text-sm font-medium animate-pulse">{isUpscaling ? 'HD Upscaling...' : 'Meracik Visual...'}</p></div>}

                            {(generatedImage || productImage) && !isGeneratingImg && !isUpscaling && (
                                <div className="relative h-full w-full flex items-center justify-center p-4 overflow-hidden">
                                    {/* MAIN IMAGE - OBJECT CONTAIN */}
                                    <img src={showCompare && productImage ? productImage : (generatedImage || productImage)} className={`w-full h-full object-contain rounded-lg border border-zinc-800 shadow-2xl transition-transform duration-500 ${videoMode && isPlaying ? 'scale-105 duration-[10s]' : 'scale-100'}`} alt="Result" />
                                    
                                    {videoMode && generatedImage && (
                                        <div className="absolute inset-0 flex items-center justify-center bg-black/20 z-10 pointer-events-none">
                                            <div className="absolute right-4 bottom-20 flex flex-col gap-4 animate-in slide-in-right fade-in">
                                                <div className="w-10 h-10 bg-zinc-800 rounded-full flex items-center justify-center border border-white/10"><div className="w-6 h-6 bg-red-500 rounded-full"></div></div>
                                                <div className="text-white text-xs drop-shadow-md text-center">88K</div>
                                            </div>
                                            {!isPlaying && <Play className="w-16 h-16 text-white/80 fill-white/20 backdrop-blur-sm rounded-full p-2"/>}
                                        </div>
                                    )}

                                    {generatedImage && productImage && (
                                        <>
                                            <button onMouseDown={() => setShowCompare(true)} onMouseUp={() => setShowCompare(false)} onMouseLeave={() => setShowCompare(false)} onTouchStart={() => setShowCompare(true)} onTouchEnd={() => setShowCompare(false)} className="absolute bottom-6 right-6 bg-black/60 backdrop-blur-md px-4 py-2 rounded-full text-xs font-bold text-white border border-white/20 shadow-lg hover:bg-black/80 transition-all select-none active:scale-95 flex items-center gap-2"><Eye size={14}/> Tahan: Bandingkan</button>
                                            
                                            {!showCompare && (
                                                <div className="absolute bottom-6 left-6 flex flex-col gap-2 pointer-events-none opacity-80">
                                                    <div className="bg-black/60 backdrop-blur-md px-3 py-1 rounded-full text-[10px] text-white border border-white/20 text-center w-fit">Original</div>
                                                    <img src={productImage} className="w-20 h-28 object-contain rounded-lg border border-zinc-700 bg-black/40" alt="Ori"/>
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            )}

                            {generatedBatch.length > 1 && !isGeneratingImg && (
                                <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 p-2 bg-black/80 backdrop-blur-md rounded-xl border border-zinc-800 z-20">
                                    {generatedBatch.map((img, idx) => (
                                        <button key={idx} onClick={() => { setGeneratedImage(img); setVideoMode(false); }} className={`w-10 h-10 rounded-lg overflow-hidden border-2 transition-all ${generatedImage === img ? 'border-[#00f2ea] scale-110' : 'border-transparent opacity-60 hover:opacity-100'}`}><img src={img} className="w-full h-full object-cover"/></button>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* RIGHT CONTROLS */}
                        <div className="w-[400px] bg-zinc-950 border-l border-zinc-800 flex flex-col z-20 shadow-2xl">
                            <div className="flex border-b border-zinc-800">
                                <button onClick={() => setShowScriptPanel(false)} className={`flex-1 py-4 text-sm font-medium flex items-center justify-center gap-2 transition-colors ${!showScriptPanel ? 'text-[#00f2ea] border-b-2 border-[#00f2ea] bg-zinc-900/50' : 'text-zinc-500 hover:text-white'}`}><ImagePlus size={16}/> Visual Studio</button>
                                <button onClick={() => { if(generatedImage) handleGenerateScript(); else setShowScriptPanel(true); }} className={`flex-1 py-4 text-sm font-medium flex items-center justify-center gap-2 transition-colors ${showScriptPanel ? 'text-[#ff0050] border-b-2 border-[#ff0050] bg-zinc-900/50' : 'text-zinc-500 hover:text-white'}`}><Mic size={16}/> Voice & Script</button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-5 custom-scrollbar">
                                {!showScriptPanel ? (
                                    <div className="space-y-6 animate-in slide-in-from-left-4 fade-in">
                                        <div className="space-y-2">
                                            <div className="flex justify-between items-center"><label className="text-xs font-bold text-zinc-500 uppercase">1. Mode Referensi</label><div className="flex gap-1">{refTypes.map(t => (<button key={t.id} onClick={() => setReferenceType(t.id)} title={t.label} className={`flex items-center gap-1 px-2 py-1 rounded text-[10px] font-bold border transition-all ${referenceType === t.id ? 'bg-[#00f2ea]/20 border-[#00f2ea] text-[#00f2ea]' : 'bg-zinc-900 border-zinc-800 text-zinc-500 hover:text-zinc-300'}`}>{renderRefIcon(t.id)} {t.label}</button>))}</div></div>
                                            
                                            {/* PRODUCT UPLOAD */}
                                            <div className={`relative transition-all ${isDraggingProduct ? 'scale-[1.02] ring-2 ring-[#00f2ea]' : ''}`} onDragOver={(e) => handleDragOver(e, setIsDraggingProduct)} onDragLeave={(e) => handleDragLeave(e, setIsDraggingProduct)} onDrop={(e) => handleDrop(e, setIsDraggingProduct, setProductImage)}>
                                                <label htmlFor="product-upload" className={`flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-xl transition-all cursor-pointer group bg-zinc-900 overflow-hidden ${isDraggingProduct ? 'border-[#00f2ea] bg-zinc-800' : 'border-zinc-700 hover:border-[#00f2ea] hover:bg-zinc-900/50'}`}>
                                                    {productImage ? (
                                                    <div className="w-full h-full p-2 flex items-center justify-center bg-black/40"><img src={productImage} className="w-full h-full object-contain pointer-events-none"/></div>
                                                    ) : (
                                                    <div className="flex flex-col items-center pointer-events-none"><Box className={`w-8 h-8 mb-2 ${isDraggingProduct ? 'text-[#00f2ea]' : 'text-zinc-500 group-hover:text-[#00f2ea]'}`}/><span className="text-xs text-zinc-400 font-medium">{isDraggingProduct ? 'Lepaskan Foto!' : 'Upload Foto Produk'}</span></div>
                                                    )}
                                                </label>
                                                <input id="product-upload" type="file" className="hidden" accept="image/*" onChange={handleProductUpload} />
                                                {productImage && <button onClick={() => {setProductImage(null); setGeneratedImage(null);}} className="absolute top-2 right-2 bg-black/60 hover:bg-red-500/90 backdrop-blur-md rounded-full p-1.5 text-white transition-colors z-10 border border-white/10"><Trash2 size={14}/></button>}
                                            </div>

                                            {/* REF UPLOAD */}
                                            {referenceType !== 'Product' && (
                                                <div className={`relative mt-2 animate-in slide-in-from-right-4 fade-in transition-all ${isDraggingRef ? 'scale-[1.02] ring-2 ring-[#ff0050]' : ''}`} onDragOver={(e) => handleDragOver(e, setIsDraggingRef)} onDragLeave={(e) => handleDragLeave(e, setIsDraggingRef)} onDrop={(e) => handleDrop(e, setIsDraggingRef, setRefImage)}>
                                                    <div className="absolute left-1/2 -top-3 -translate-x-1/2 z-10 bg-zinc-950 p-1 rounded-full border border-zinc-800 shadow-sm"><Plus size={12} className="text-zinc-500"/></div>
                                                    <label htmlFor="ref-upload" className={`flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-xl transition-all cursor-pointer group bg-zinc-900 overflow-hidden ${isDraggingRef ? 'border-[#ff0050] bg-zinc-800' : 'border-zinc-700 hover:border-[#ff0050] hover:bg-zinc-900/50'}`}>
                                                        {refImage ? <div className="w-full h-full p-2 flex items-center justify-center bg-black/40"><img src={refImage} className="w-full h-full object-contain pointer-events-none"/></div> : <div className="flex flex-col items-center pointer-events-none">{renderRefIcon(referenceType)}<span className="text-xs text-zinc-400 font-medium">{isDraggingRef ? 'Lepaskan Foto!' : `Upload ${referenceType}`}</span></div>}
                                                    </label>
                                                    <input id="ref-upload" type="file" className="hidden" accept="image/*" onChange={handleRefUpload} />
                                                    {refImage && <button onClick={() => setRefImage(null)} className="absolute top-2 right-2 bg-black/60 hover:bg-red-500/90 backdrop-blur-md rounded-full p-1.5 text-white transition-colors z-10 border border-white/10"><Trash2 size={14}/></button>}
                                                </div>
                                            )}
                                        </div>

                                        <div className="space-y-2">
                                            <div className="flex justify-between items-center"><label className="text-xs font-bold text-zinc-500 uppercase">2. Deskripsi Detail</label>{isAnalyzingProduct && <span className="text-[10px] text-[#00f2ea] animate-pulse flex items-center gap-1"><Wand2 size={10}/> AI Menganalisa...</span>}</div>
                                            <textarea value={prompt} onChange={(e) => setPrompt(e.target.value)} placeholder={isAnalyzingProduct ? "Sedang membaca foto..." : "Contoh: Botol minum hijau..."} className="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 text-sm text-white focus:border-[#00f2ea] outline-none min-h-[80px] resize-none" />
                                        </div>

                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-zinc-500 uppercase">3. Gaya Visual</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                {styles.map(s => (<button key={s.id} onClick={() => setArtStyle(s.id)} className={`relative p-3 rounded-xl border text-left transition-all overflow-hidden group ${artStyle === s.id ? 'border-[#00f2ea] bg-zinc-900' : 'border-zinc-800 bg-zinc-950 hover:bg-zinc-900'}`}><div className={`absolute top-0 right-0 w-12 h-12 bg-gradient-to-bl ${s.color} blur-xl opacity-20 group-hover:opacity-40`}></div><div className="font-bold text-xs text-white relative z-10">{s.label}</div><div className="text-[10px] text-zinc-500 mt-1 relative z-10 leading-tight">{s.desc}</div></button>))}
                                            </div>
                                        </div>

                                        <button onClick={handleGenerateImage} disabled={isGeneratingImg || (!prompt && !productImage)} className={`w-full py-4 rounded-xl font-bold text-black flex items-center justify-center gap-2 transition-all shadow-lg shadow-[#00f2ea]/20 ${isGeneratingImg ? 'bg-zinc-800 text-zinc-500 cursor-not-allowed' : 'bg-gradient-to-r from-[#00f2ea] to-[#00c2ff] hover:scale-[1.02] active:scale-[0.98]'}`}>
                                            {isGeneratingImg ? <Loader2 className="animate-spin w-5 h-5"/> : <Sparkles className="w-5 h-5 fill-black"/>}
                                            {isGeneratingImg ? 'Sedang Meracik...' : 'Buat Konten Viral'}
                                        </button>

                                        {generatedImage && !isGeneratingImg && (
                                            <div className="grid grid-cols-2 gap-2 pt-4 border-t border-zinc-800">
                                                <button onClick={handleUpscale} className="flex items-center justify-center gap-2 py-3 bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 hover:border-emerald-500/50 rounded-lg text-xs font-medium text-zinc-300 transition-colors">{isUpscaling ? <Loader2 className="animate-spin w-3 h-3"/> : <ScanEye size={14}/>} HD Upscale</button>
                                                <button onClick={handleGenerateVideo} className="flex items-center justify-center gap-2 py-3 bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 hover:border-purple-500/50 rounded-lg text-xs font-medium text-zinc-300 transition-colors"><Video size={14}/> Buat Video</button>
                                                <button onClick={handleDownload} className="col-span-2 flex items-center justify-center gap-2 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-xs font-medium text-white transition-colors"><Download size={14}/> Download Hasil</button>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="space-y-6 animate-in slide-in-from-right-4 fade-in">
                                        {generatedScript ? (
                                            <div className="space-y-4">
                                                <button onClick={() => navigator.clipboard.writeText(`${generatedScript.hook}\n\n${typeof generatedScript.script_body === 'string' ? generatedScript.script_body : JSON.stringify(generatedScript.script_body)}\n\n${generatedScript.cta}\n\n${generatedScript.hashtags}`)} className="w-full py-2 bg-zinc-800 text-white rounded-lg text-xs flex items-center justify-center gap-2 hover:bg-zinc-700"><Copy size={14}/> Copy Semua (Caption)</button>
                                                
                                                <div className="group relative bg-zinc-900 border border-zinc-800 p-4 rounded-xl hover:border-[#ff0050]/50 transition-colors"><label className="text-[10px] font-bold text-[#ff0050] uppercase tracking-wider mb-1 block">Hook</label><p className="text-sm font-medium text-white leading-relaxed">"{generatedScript.hook}"</p></div>
                                                <div className="group relative bg-zinc-900 border border-zinc-800 p-4 rounded-xl hover:border-blue-500/50 transition-colors"><label className="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-1 block">Script</label><p className="text-sm text-zinc-300 leading-relaxed whitespace-pre-wrap">{typeof generatedScript.script_body === 'string' ? generatedScript.script_body : JSON.stringify(generatedScript.script_body)}</p></div>
                                                <div className="group relative bg-zinc-900 border border-zinc-800 p-4 rounded-xl hover:border-green-500/50 transition-colors"><label className="text-[10px] font-bold text-green-400 uppercase tracking-wider mb-1 block">Closing</label><p className="text-sm font-bold text-white mb-2">{generatedScript.cta}</p><p className="text-xs text-zinc-500 font-mono">{generatedScript.hashtags}</p></div>
                                                
                                                <div className="pt-4 border-t border-zinc-800">
                                                    {voiceUrl ? (
                                                        <div className="bg-[#00f2ea]/10 border border-[#00f2ea]/30 p-3 rounded-xl flex items-center justify-between">
                                                            <div className="flex items-center gap-3"><button onClick={handleAudioPlay} className="w-10 h-10 bg-[#00f2ea] text-black rounded-full flex items-center justify-center hover:scale-105 transition-transform">{isAudioPlaying ? <Pause size={18} fill="black"/> : <Play size={18} fill="black"/>}</button><div><div className="text-xs font-bold text-[#00f2ea]">AI Voice Ready</div><div className="text-[10px] text-zinc-400">Duration: ~15s</div></div></div>
                                                            <a href={voiceUrl} download="voiceover.wav" className="p-2 hover:bg-black/20 rounded-lg text-zinc-400 hover:text-white transition-colors"><Download size={18}/></a>
                                                        </div>
                                                    ) : (
                                                        <button onClick={handleGenerateVoiceover} disabled={isGeneratingVoice} className="w-full py-3 bg-zinc-800 hover:bg-zinc-700 text-white rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2">{isGeneratingVoice ? <Loader2 size={16} className="animate-spin"/> : <Mic size={16}/>}{isGeneratingVoice ? 'Sedang Merekam...' : 'Generate AI Voiceover'}</button>
                                                    )}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="text-center py-10 px-4 border border-dashed border-zinc-800 rounded-xl"><Type className="w-10 h-10 text-zinc-700 mx-auto mb-2"/><p className="text-sm text-zinc-500 mb-4">Belum ada script.</p><button onClick={handleGenerateScript} className="px-6 py-3 bg-white text-black text-xs font-bold rounded-xl hover:bg-zinc-200">Buat Script Sekarang</button></div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    {error && <div className="absolute top-20 left-1/2 -translate-x-1/2 bg-red-500/90 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl animate-in slide-in-from-top-4 fade-in z-50 flex items-center gap-2"><MinusCircle size={16}/> {error}</div>}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><TikTokAffiliateStudio /></ErrorBoundary>);
    </script>
</body>
</html>
